<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta charset="utf-8">
    <title>CodeMirror: DQM GUI rendering</title>
    <style>$CSS</style>
    <script>
    var plugin;
    var ROOTPATH = "/dqm/offline"
        </script><script>
    $JAVASCRIPT
    $YAHOO
    $UTIL
    </script>
    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="http://codemirror.net/lib/codemirror.js"></script>
    <script type="text/javascript" src="https://raw.github.com/gidlews/editor/master/mode/javascript/javascript.js"></script>
    <script type="text/javascript" src="http://codemirror.net/addon/fold/foldcode.js"></script>
    <script type="text/javascript" src="http://codemirror.net/addon/dialog/dialog.js"></script>
    <script type="text/javascript" src="http://codemirror.net/addon/search/searchcursor.js"></script>
    <script type="text/javascript" src="http://codemirror.net/addon/search/search.js"></script>
    <script id="plotjs" type="text">$PLOTJS</script>
    <link rel=stylesheet href="http://codemirror.net/lib/codemirror.css">
    <style type=text/css>
      .CodeMirror {
        float: left;
        width: 50%;
        height: 550px;
        border: 1px solid black;
      }
      #tmp{
          float: left;
          width: 49%;
          height: 550px;
          border: 1px solid black;
        }
      svg {
          margin-left: 20px;
          margin-top:  20px;
      }
      pre, code {
          font-size: 1em !important;
      }
    </style>
  </head>
  <body>
    <h1>CodeMirror: DQM GUI rendering</h1>
    <textarea id="code">
    </textarea>
    <div id="tmp">
        <select id="loadPlugin"></select>
        <div id="preview"></div>
    </div>
    <script>

      var pluginList = ["https://raw.github.com/gidlews/plugin/master/def.js", "https://raw.github.com/gidlews/plugin/master/plot.js", "https://raw.github.com/gidlews/plugin/master/plot2.js"]
      d3.select("#loadPlugin").on("change",function() {
          plugin = null;
          YAHOO.util.Get.script(this.value, {
              onSuccess: function(obj) {
                  editor.setValue("plugin = " + plugin.toString());
                  eval(editor.getValue())
                  var cursor = editor.getSearchCursor("function");
                  var funLineArray = []
                  while(cursor.findNext()) {
                      funLineArray.push(cursor.pos.from.line)
                  }
                  for(var i in funLineArray.reverse()) {
                      if(funLineArray[i] != 0)
                          foldFunc(editor, funLineArray[i]);
                  }
                  updatePreview()
              }
          })
      })
      for(var i in pluginList) {
          d3.select("#loadPlugin").append("option")
           .attr("id",i)
           .text(pluginList[i])
           .attr("value", pluginList[i])
           
      }
      var delay;
      // Initialize CodeMirror editor with a nice html5 canvas demo.
      var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
        mode: 'text/javascript',
        lineNumbers: true,
        tabMode: 'indent'
      });

      editor.on("change", function() {
        clearTimeout(delay);
        delay = setTimeout(updatePreview, 300);
      });
      foldFunc = CodeMirror.newFoldFunction(CodeMirror.braceRangeFinder);
      editor.on("gutterClick",foldFunc);
      var json;
      function updatePreview() {
        var previewDiv = document.getElementById('preview');
        d3.select(previewDiv).select("*").remove();
        var svg = d3.select(previewDiv).append("svg");
        d3.text(document.URL.replace("editfairy", "jsonfairy"), function(data) {
            try{
                json = JSON.parse(data);
                eval(editor.getValue())
                var drawPlugin;
                if(plugin != null) {
                    var _plugin = new plugin();
                    _plugin.drawHist(json, svg , 500, 500, new Date());
                }
                else
                    _def.drawHist(json, svg , 500, 500, new Date());
                
  
            } catch(error) {
                defPlugin().drawErrorBox(svg, error, 400, 400, false)
            }
        })
      }
      
      var url = document.URL.replace("edit","plotjson");
      editor.setValue(document.getElementById("plotjs").innerHTML)
      
      var cursor = editor.getSearchCursor("function");
      var funLineArray = []
      while(cursor.findNext()) {
          funLineArray.push(cursor.pos.from.line)
      }
      for(var i in funLineArray.reverse()) {
          if(funLineArray[i] != 0)
              foldFunc(editor, funLineArray[i]);
      }

    </script>
  </body>
</html>