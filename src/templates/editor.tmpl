<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta charset="utf-8">
    <title>CodeMirror: DQM GUI rendering</title>
    <style>$CSS</style>
    <script>
    var ROOTPATH = "/dqm/offline"
        </script><script>
    $JAVASCRIPT
    </script>
    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="http://codemirror.net/lib/codemirror.js"></script>
    <script type="text/javascript" src="https://raw.github.com/gidlews/editor/master/mode/javascript/javascript.js"></script>
    <script type="text/javascript" src="http://codemirror.net/addon/fold/foldcode.js"></script>
    <script type="text/javascript" src="http://codemirror.net/addon/dialog/dialog.js"></script>
    <script type="text/javascript" src="http://codemirror.net/addon/search/searchcursor.js"></script>
    <script type="text/javascript" src="http://codemirror.net/addon/search/search.js"></script>
    <script id="plotjs" type="text">$PLOTJS</script>
    <link rel=stylesheet href="http://home.elka.pw.edu.pl/~tgidlews/code/codemirror.css">
    <link rel=stylesheet href="https://raw.github.com/gidlews/editor/master/doc/docs.css"> 
    <style type=text/css>
      .CodeMirror {
        float: left;
        width: 50%;
        border: 1px solid black;
      }
      #preview {
          float: left;
          width: 49%;
          height: 550px;
          border: 1px solid black;
        }
      svg {
          margin-left: 20px;
          margin-top:  20px;
      }
      pre, code {
          font-size: 1em !important;
      }
    </style>
  </head>
  <body>
    <h1>CodeMirror: DQM GUI rendering</h1>
    <textarea id=code name=code>
    </textarea>
    <div id="preview"></div>
    <script>
   
      var delay;
      // Initialize CodeMirror editor with a nice html5 canvas demo.
      var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
        mode: 'text/javascript',
        lineNumbers: true,
        tabMode: 'indent'
      });
      editor.on("change", function() {
        clearTimeout(delay);
        delay = setTimeout(updatePreview, 300);
      });
      foldFunc = CodeMirror.newFoldFunction(CodeMirror.braceRangeFinder);
      editor.on("gutterClick",foldFunc);
      
      function updatePreview() {
        var previewDiv = document.getElementById('preview');
        d3.select(previewDiv).select("*").remove();
        var svg = d3.select(previewDiv).append("svg");
        d3.text(document.URL.replace("editfairy", "jsonfairy"), function(data) {
            try{
                var json = JSON.parse(data);
                eval(editor.getValue())
                drawHist(json, svg , 500, 500, new Date())
            } catch(error) {
                drawErrorBox(svg, error, 400, 400, false)
            }
        })
      }
      
      var url = document.URL.replace("edit","plotjson");
      editor.setValue(document.getElementById("plotjs").innerHTML)
      
      var cursor = editor.getSearchCursor("function");
      var funLineArray = []
      while(cursor.findNext()) {
          funLineArray.push(cursor.pos.from.line)
      }
      for(var i in funLineArray.reverse()) {
          foldFunc(editor, funLineArray[i]);
      }

    </script>
  </body>
</html>